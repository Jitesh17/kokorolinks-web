---
import WeddingLayout from "../layouts/WeddingLayout.astro";
import fs from "node:fs";
import path from "node:path";

export async function getStaticPaths() {
  try {
    const dataDir = path.join(process.cwd(), "public", "weddings", "data");
    if (!fs.existsSync(dataDir)) return [];
    const files = fs.readdirSync(dataDir);
    return files
      .filter((f) => f.endsWith(".json") && f !== "template.json")
      .map((f) => ({ params: { slug: f.replace(/\.json$/, "") } }));
  } catch (error) {
    return [];
  }
}

const slug = "manvi-manish";
const baseUrl = import.meta.env.BASE_URL;

// --- NEW: READ DATA SERVER-SIDE FOR META TAGS ---
// This runs during build so WhatsApp sees the real data
const dataPath = path.join(process.cwd(), "public", "weddings", "data", `${slug}.json`);
let meta = {
  title: "Wedding Invitation",
  description: "Join us to celebrate our special day.",
  image: ""
};

if (fs.existsSync(dataPath)) {
  try {
    const raw = fs.readFileSync(dataPath, "utf-8");
    const json = JSON.parse(raw);
    
    // 1. Better Title
    if (json.coupleNames) {
      meta.title = `${json.coupleNames} | Wedding Invitation`;
    }
    
    // 2. Better Description
    if (json.tagline) {
      meta.description = json.tagline;
    } else if (json.coupleNames) {
      meta.description = `You are cordially invited to the wedding of ${json.coupleNames}.`;
    }

    // 3. Preview Image (Must be a full absolute URL)
    // IMPORTANT: Replace 'https://kokorolinks.com' with your actual domain variable if available
    const domain = "https://kokorolinks.com"; 
    if (json.media?.couplePhoto?.src) {
      const cleanSrc = json.media.couplePhoto.src.startsWith("/") 
        ? json.media.couplePhoto.src 
        : "/" + json.media.couplePhoto.src;
      meta.image = `${domain}${cleanSrc}`;
    }
  } catch (e) {
    console.error("Error reading metadata", e);
  }
}

const detailsUrl = `${baseUrl}weddings/data/${slug}.json`;
const calendarUrl = `${baseUrl}weddings/calendars/${slug}.ics`;
---

<WeddingLayout 
  title={meta.title} 
  description={meta.description} 
  image={meta.image}
>
  <noscript>
    <div class="mx-auto max-w-2xl px-4 py-10">
      <div class="rounded-2xl border p-6 dark:border-neutral-800">
        This page needs JavaScript enabled to show the invitation.
      </div>
    </div>
  </noscript>

  <div id="protectedContent">
    <div id="themeWrapper" class="relative min-h-screen overflow-hidden">
      <div id="decorCorners" class="pointer-events-none absolute inset-0 hidden z-0">
        <div id="decorTL" class="absolute left-0 top-0"></div>
        <div id="decorTR" class="absolute right-0 top-0"></div>
        <div id="decorBL" class="absolute left-0 bottom-0"></div>
        <div id="decorBR" class="absolute right-0 bottom-0"></div>
      </div>

      <div class="card-joy relative z-10 mx-auto max-w-3xl shadow-2xl">
        <div class="p-6">
            <div id="couplePhotoWrap" class="hidden flex justify-center mb-6">
              <img 
                id="couplePhoto" 
                class="object-cover shadow-2xl border-4 border-white dark:border-neutral-800" 
                loading="eager"
              />
            </div>
            <div class="text-center space-y-4 mt-6">

            <h1 id="coupleNames" class="font-heading text-6xl sm:text-7xl font-medium tracking-wide text-neutral-900 dark:text-white leading-tight animate-pulse">
              Wedding Invitation
            </h1>
            <p id="tagline" class="font-heading text-xl italic text-neutral-600 dark:text-neutral-400"></p>
            
            <div class="py-4">
              <div id="weddingDate" class="font-heading text-3xl text-neutral-800 dark:text-neutral-200"></div>
              <div id="cityLine" class="font-body text-sm uppercase tracking-widest text-neutral-500 mt-2"></div>
            </div>
          </div>

          <div id="countdown" class="flex justify-center my-8"></div>

          <div class="flex flex-col items-center gap-4 mb-12">
            
            <a id="mapBtn" class="px-8 py-3 rounded-full bg-neutral-900 text-white font-medium text-sm hover:bg-neutral-800 transition-all hover:scale-105 dark:bg-white dark:text-black cursor-pointer shadow-lg shadow-neutral-500/20" target="_blank" rel="noopener">
              Open Location Map
            </a>

            <div class="flex flex-row gap-3">
              <a id="subscribeBtn" class="px-5 py-2 rounded-full border border-neutral-300 text-neutral-600 font-medium text-xs hover:border-black hover:text-black transition-colors dark:border-neutral-700 dark:text-neutral-400 dark:hover:text-white cursor-pointer">
                ‚Üª Sync Calendar
              </a>
              
              <a id="viewCalendarBtn" class="px-5 py-2 rounded-full border border-neutral-300 text-neutral-600 font-medium text-xs hover:border-black hover:text-black transition-colors dark:border-neutral-700 dark:text-neutral-400 dark:hover:text-white cursor-pointer" target="_blank" rel="noopener">
                ‚Üì Save to Calendar
              </a>
            </div>

          </div>   
          
          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="font-heading text-3xl text-neutral-900 dark:text-white mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">Schedule</h2>
            <div id="schedule" class="mt-4 grid gap-3"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800">
            <h2 class="font-heading text-3xl text-neutral-900 dark:text-white mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">Contacts</h2>
            <div id="contacts" class="mt-4 grid gap-2 text-sm text-neutral-600 dark:text-neutral-400"></div>
          </div>

          <div class="mt-8 border-t pt-6 dark:border-neutral-800" id="rsvpSection" style="display:none;">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white" id="rsvpTitle">RSVP</h2>
            <p class="mt-2 text-sm text-neutral-600 dark:text-neutral-400" id="rsvpDeadlineText" style="display:none;"></p>

            <div class="mt-4" id="rsvpButtonWrap" style="display:none;">
              <a id="rsvpButton" class="inline-block rounded-xl border px-4 py-2 text-sm font-semibold dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800">
                RSVP
              </a>
              <div class="mt-2 text-xs text-neutral-600 dark:text-neutral-400">
                <a id="rsvpOpenInNewTab" target="_blank" rel="noopener" class="underline">Open in Google Forms</a>
              </div>
            </div>

            <div class="mt-4" id="rsvpEmbedWrap" style="display:none;">
              <iframe
                id="rsvpIframe"
                title="RSVP Form"
                class="w-full rounded-2xl border dark:border-neutral-800"
                style="height: 900px;"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>
          </div>

           <div id="missingMsg" class="hidden mt-8 text-center text-sm text-red-600 dark:text-red-400">
            Invitation data not found for this link.
           </div>

        </div>
      </div>
    </div>
  </div>
<script is:inline define:vars={{ detailsUrl, calendarUrl, slug, baseUrl }}>
    const $ = (id) => document.getElementById(id);

    // --- Helpers ---
    function pad2(n) { return String(n).padStart(2, "0"); }
    function isAbsUrl(u) { return typeof u === "string" && /^(https?:|data:)/i.test(u); }
    
    function resolveAssetUrl(u) {
      if (!u) return "";
      if (isAbsUrl(u)) return u;
      const baseNoSlash = String(baseUrl || "/").replace(/\/$/, "");
      if (u.startsWith("/")) return baseNoSlash + u;
      return String(baseUrl || "/") + u;
    }

    function formatLocal(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { weekday: "short", year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function setupScrollObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      
      document.querySelectorAll('.reveal-entry').forEach(el => observer.observe(el));
    }

    // --- Components ---
    function renderCountdown(el, targetIso) {
      if (!el || el.querySelector('.countdown-unit')) return;
      
      el.className = "flex flex-wrap gap-6 sm:gap-10 justify-center w-full my-6"; 
      el.innerHTML = `
        <div class="countdown-unit text-center min-w-[60px]"><div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="d">0</div><div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Days</div></div>
        <div class="countdown-unit text-center min-w-[60px]"><div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="h">00</div><div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Hrs</div></div>
        <div class="countdown-unit text-center min-w-[60px]"><div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="m">00</div><div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Mins</div></div>
        <div class="countdown-unit text-center min-w-[60px]"><div class="font-heading text-4xl sm:text-5xl text-neutral-900 dark:text-white leading-none" data-type="s">00</div><div class="text-[10px] uppercase tracking-widest text-neutral-500 mt-2 font-medium">Secs</div></div>
      `;

      const [dEl, hEl, mEl, sEl] = ['d','h','m','s'].map(k => el.querySelector(`[data-type="${k}"]`));
      
      function tick() {
        const ms = new Date(targetIso).getTime() - Date.now();
        if (ms <= 0) { el.innerHTML = `<div class="font-heading text-3xl text-neutral-900 dark:text-white animate-pulse">Happening now</div>`; return false; }
        const s = Math.floor(ms/1000);
        if (dEl) dEl.textContent = Math.floor(s/86400);
        if (hEl) hEl.textContent = pad2(Math.floor((s%86400)/3600));
        if (mEl) mEl.textContent = pad2(Math.floor((s%3600)/60));
        if (sEl) sEl.textContent = pad2(s%60);
        return true;
      }
      if (tick()) setInterval(tick, 1000);
    }

    function buildGoogleCalendarLink(ev) {
      const start = new Date(ev?.start);
      const end = new Date(ev?.end);
      if (isNaN(start) || isNaN(end)) return "https://calendar.google.com/";
      const fmt = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      const details = encodeURIComponent(String(ev?.notes || ""));
      const location = encodeURIComponent([ev?.locationName, ev?.address].filter(Boolean).join(", "));
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev?.title||"Event")}&dates=${fmt(start)}/${fmt(end)}&details=${details}&location=${location}`;
    }

    /**
     * Core Theme Engine
     * Controls Dark, Light, or Dynamic (System) modes
     * Unifies page background to prevent mismatch lines
     */
    function initThemeEngine(theme) {
      const root = document.documentElement;
      const wrapper = $("themeWrapper");
      if (!root) return;

      // 1. Single Control Variable from JSON
      const mode = (theme?.mode || "dynamic").toLowerCase();
      
      const applyFinalState = (isDark) => {
        if (isDark) {
          root.classList.add("dark");
          root.classList.remove("light");
          // This property forces the browser's UI (inputs, etc.) to Dark
          root.style.setProperty('color-scheme', 'dark');
        } else {
          root.classList.remove("dark");
          root.classList.add("light");
          // This property forces the browser's UI to Light
          root.style.setProperty('color-scheme', 'light');
        }
        
        // 2. Unify Backgrounds to prevent mismatch lines
        const bgHex = isDark ? "#171717" : "#ffffff";
        document.body.style.backgroundColor = bgHex;
        if (wrapper) wrapper.style.backgroundColor = bgHex;
      };

      // 3. Execution Logic
      if (mode === "dark") {
        applyFinalState(true);
      } else if (mode === "light") {
        applyFinalState(false);
      } else {
        // Dynamic Mode: Link to System Preference
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        applyFinalState(mediaQuery.matches);
        
        // Listen for browser changes ONLY if set to dynamic
        mediaQuery.onchange = (e) => applyFinalState(e.matches);
      }

      // 4. Handle JSON Background Overrides
      if (wrapper && theme?.background === "image" && theme.imageUrl) {
        wrapper.style.backgroundImage = `url('${resolveAssetUrl(theme.imageUrl)}')`;
        wrapper.style.backgroundSize = "cover";
        wrapper.style.backgroundPosition = "center";
      }
    }

    function applyTheme(theme) {
      const wrapper = $("themeWrapper");
      if (!wrapper) return;
      wrapper.style.backgroundImage = "";
      wrapper.classList.remove("bg-gradient-to-br");
      if (!theme) return;
      if (theme.background === "gradient" && theme.gradient) {
        wrapper.classList.add("bg-gradient-to-br");
        theme.gradient.split(" ").forEach(c => wrapper.classList.add(c));
      } else if (theme.background === "image" && theme.imageUrl) {
        wrapper.style.backgroundImage = `url('${resolveAssetUrl(theme.imageUrl)}')`;
        wrapper.style.backgroundSize = "cover";
        wrapper.style.backgroundPosition = "center";
      }
    }

function applyDecor(details) {
      const root = $("decorCorners");
      if (!root) return;
      
      // Reset styles
      ["TL","TR","BL","BR"].forEach(k => { 
        const el = $(`decor${k}`); 
        if(el) { el.style = ""; el.style.backgroundRepeat = "no-repeat"; } 
      });
      root.classList.add("hidden");

      const d = details?.decor || details?.theme?.decor;
      if (!d || d.enabled !== true) return;

      const size = d.size || 360;
      const opacity = document.documentElement.classList.contains("dark") ? (d.opacityDark||0.16) : (d.opacityLight||0.28);
      const baseRot = d.rotation || 0;
      const autoRot = d.rotate !== false;

      const setCorner = (id, key, offset) => {
        const el = $(id);
        const config = d.corners?.[key]; // Specific corner config
        const url = config?.imageUrl || d.imageUrl;
        
        if (!el || !url) return;

        // 1. Calculate Rotation
        const rot = baseRot + offset + (Number(config?.rotation) || 0);

        // 2. Calculate Flip (New Logic)
        const flip = (config?.flip || d.flip || "").toLowerCase();
        let scale = "";
        if (flip === "horizontal" || flip === "x") scale = "scaleX(-1)";
        else if (flip === "vertical" || flip === "y") scale = "scaleY(-1)";
        else if (flip === "both" || flip === "xy") scale = "scale(-1)";

        // 3. Apply Styles
        el.style.width = `${size}px`; 
        el.style.height = `${size}px`; 
        el.style.opacity = opacity;
        el.style.backgroundImage = `url('${resolveAssetUrl(url)}')`; 
        el.style.backgroundSize = "contain";
        el.style.backgroundPosition = "center"; 
        
        // Combine transforms: Rotate first, then Flip locally
        el.style.transform = `rotate(${rot}deg) ${scale}`;
        
        root.classList.remove("hidden");
      };

      setCorner("decorTL", "tl", 0); 
      setCorner("decorTR", "tr", autoRot ? 90 : 0);
      setCorner("decorBL", "bl", autoRot ? -90 : 0); 
      setCorner("decorBR", "br", autoRot ? 180 : 0);
    }

function renderRsvp(rsvp) {
      const section = $("rsvpSection");
      const button = $("rsvpButton");
      const btnWrap = $("rsvpButtonWrap");
      const embedWrap = $("rsvpEmbedWrap");
      const iframe = $("rsvpIframe");
      const dl = $("rsvpDeadlineText");

      if (!section || !button) return;
      section.style.display = "none";
      
      if (!rsvp || rsvp.enabled !== true) return;
      section.style.display = "block";
      
      $("rsvpTitle").textContent = rsvp.title || "RSVP";
      
      if (rsvp.deadline) {
        dl.textContent = `RSVP deadline: ${formatLocal(rsvp.deadline)}`;
        dl.style.display = "block";
      } else {
        dl.style.display = "none";
      }

      // Maroon Styling (Coordinated with your photo)
      button.className = "inline-block rounded-full px-10 py-3 text-sm font-semibold text-white transition-all hover:scale-105 shadow-lg bg-[#8b0000] hover:bg-[#a00000] shadow-rose-900/20 border-0 cursor-pointer";

      const isEmbed = String(rsvp.mode).toLowerCase() === "embed" && rsvp.embedUrl;

      if (isEmbed) {
        btnWrap.style.display = "block";
        button.textContent = rsvp.buttonText || "RSVP Now";
        
        button.onclick = (e) => {
          e.preventDefault();
          const isOpening = embedWrap.style.display === "none";
          
          if (isOpening) {
            // Open logic
            embedWrap.style.display = "block";
            button.textContent = "Close RSVP Form";
            button.classList.replace("bg-[#8b0000]", "bg-neutral-500"); // Change color when open
            button.classList.replace("hover:bg-[#a00000]", "hover:bg-neutral-600");
            
            if (!iframe.src) iframe.src = rsvp.embedUrl;
            embedWrap.scrollIntoView({ behavior: "smooth", block: "start" });
          } else {
            // Close logic
            embedWrap.style.display = "none";
            button.textContent = rsvp.buttonText || "RSVP Now";
            button.classList.replace("bg-neutral-500", "bg-[#8b0000]");
            button.classList.replace("hover:bg-neutral-600", "hover:bg-[#a00000]");
            section.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        };
      } else if (rsvp.formUrl) {
        // Standard Link Mode
        btnWrap.style.display = "block";
        button.textContent = rsvp.buttonText || "RSVP via Google Forms";
        button.href = rsvp.formUrl;
        button.target = "_blank";
        button.onclick = null;
      }
      
      if (rsvp.formUrl) {
        const link = $("rsvpOpenInNewTab");
        link.href = rsvp.formUrl;
        link.className = "underline text-xs text-neutral-500 hover:text-[#8b0000] transition-colors";
      }
    }

function renderCouplePhoto(details) {
      const wrap = $("couplePhotoWrap");
      const img = $("couplePhoto");
      if (!wrap || !img) return;

      wrap.classList.add("hidden");
      img.removeAttribute("src");
      img.removeAttribute("style");
      wrap.className = "hidden flex justify-center mb-6"; 
      img.className = "object-cover transition-transform duration-700 hover:scale-[1.02]";

      const photo = details?.media?.couplePhoto;
      if (!photo || photo.enabled !== true || !photo.src) return;

      img.src = resolveAssetUrl(photo.src);
      img.alt = photo.alt || "";
      const size = photo.size;

      // Adjusted default crop to pull the couple higher up
      const pos = photo.position || (size === 'hero' ? 'center 30%' : 'center');
      const tailwindMap = { "top": "object-top", "center": "object-center", "bottom": "object-bottom" };
      if (tailwindMap[pos]) img.classList.add(tailwindMap[pos]);
      else img.style.objectPosition = pos;

      if (size === 'hero') {
        wrap.classList.remove("mb-6");
        wrap.classList.add("-mx-6", "-mt-6", "mb-8", "rounded-t-2xl", "overflow-hidden");
        
        // FIX: Reduced mobile height (h-[380px]) vs laptop height (h-[550px])
        img.className += " w-full h-[380px] sm:h-[550px]"; 
      } else if (size === 'full') {
        img.style.width = '100%';
        img.style.maxWidth = '600px'; 
        img.style.height = 'auto';
        img.classList.add("rounded-2xl");
      } else {
        img.style.width = `${size || 140}px`;
        img.style.height = `${size || 140}px`;
        img.classList.add((photo.shape === "rounded") ? "rounded-2xl" : "rounded-full");
      }

      if (photo.shadow !== false) img.classList.add("shadow-2xl");
      if (photo.border !== false && size !== 'hero') {
         img.classList.add("border-4", "border-white", "dark:border-neutral-800");
      }
      wrap.classList.remove("hidden");
    }

    function renderInvite(details) {
      try {
        // 1. Text Details
        $("coupleNames").textContent = details.coupleNames || "";
        $("tagline").textContent = details.tagline || "";
        $("cityLine").textContent = details.cityLine || "";
        
        const startIso = details?.primaryEvent?.start;
        $("weddingDate").textContent = details?.primaryEvent?.displayDate || (startIso ? formatLocal(startIso) : "");
        if (details?.primaryVenue?.mapUrl) $("mapBtn").href = details.primaryVenue.mapUrl;

        // 2. Photo Layout
        renderCouplePhoto(details);

        // --- UPDATED: CINEMATIC MODE COLOR FIX ---
        const photoConfig = details.media?.couplePhoto;
        const textContainer = $("coupleNames").parentElement; 
        const photoWrap = $("couplePhotoWrap");

        if (textContainer) {
          textContainer.style.marginTop = "";
          textContainer.classList.remove("relative", "z-20", "px-4", "pb-4");
          $("coupleNames").className = "font-heading text-6xl sm:text-7xl font-medium tracking-wide leading-tight text-neutral-900 dark:text-white";
          $("tagline").className = "font-heading text-xl italic text-neutral-600 dark:text-neutral-400";
          
          const oldG = photoWrap?.querySelectorAll('.cinematic-gradient');
          if (oldG) oldG.forEach(g => g.remove());
        }

        if (photoConfig?.style === 'cinematic' && photoConfig?.enabled && photoWrap && textContainer) {
          const gradient = document.createElement('div');
          
          // FIX: Changed dark mode 'from-black' to 'from-[#171717]' (Neutral-900) 
          // to match the background of the card perfectly.
          gradient.className = "cinematic-gradient absolute inset-0 bg-gradient-to-t from-white via-white/30 dark:from-[#171717] dark:via-[#171717]/40 to-transparent pointer-events-none rounded-t-2xl";
          
          photoWrap.classList.add("relative", "overflow-hidden"); 
          photoWrap.appendChild(gradient);

          // Use Tailwind variants for text colors
          $("coupleNames").className = "font-heading text-6xl sm:text-7xl font-medium tracking-wide leading-tight text-neutral-900 dark:text-white drop-shadow-none dark:drop-shadow-[0_2px_10px_rgba(0,0,0,0.8)]";
          $("tagline").className = "font-heading text-xl italic text-neutral-800 dark:text-neutral-200 dark:drop-shadow-md";

          // Pull text over photo
          textContainer.style.marginTop = "-140px"; 
          textContainer.classList.add("relative", "z-20", "px-4", "pb-4");
        }
        // ... rest of the function remains the same ...
        // ------------------------------------------------

        // 3. Components
        if (typeof calendarUrl !== 'undefined') {
           $("subscribeBtn").href = new URL(calendarUrl, window.location.href).toString().replace(/^https:/, "webcal:");
        }
        if (startIso) renderCountdown($("countdown"), startIso);

        // 4. Schedule
        const schedule = $("schedule");
        if (schedule) {
          schedule.innerHTML = ''; schedule.className = "space-y-6 mt-6";
          for (const ev of details.schedule || []) {
            const item = document.createElement("div");
            item.className = "reveal-entry flex flex-row items-stretch gap-3 sm:gap-6 border-b border-neutral-100 dark:border-neutral-800 pb-6 last:border-0 last:pb-0";
            const d = ev.start ? new Date(ev.start) : null;
            const dp = d ? { day: d.getDate(), month: d.toLocaleDateString('en-US',{month:'short'}).toUpperCase(), week: d.toLocaleDateString('en-US',{weekday:'short'}).toUpperCase(), time: d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}) } : { day:"", month:"", week:"", time:"" };

            item.innerHTML = `
              <div class="shrink-0 flex flex-col items-center justify-center w-20 py-3 sm:w-28 sm:py-0 rounded-2xl border-2 border-neutral-100 bg-neutral-50 dark:border-neutral-700 dark:bg-neutral-900/50">
                <div class="flex flex-col items-center justify-center leading-none">
                  <div class="text-[9px] sm:text-[10px] font-bold tracking-widest text-neutral-500 uppercase mb-1">${dp.month}</div>
                  <div class="text-2xl sm:text-3xl font-heading font-bold text-neutral-900 dark:text-white">${dp.day}</div>
                  <div class="text-[9px] sm:text-[10px] font-medium text-neutral-400 mt-1 uppercase">${dp.week}</div>
                </div>
                <div class="w-10 sm:w-16 h-px bg-neutral-200 dark:bg-neutral-700 my-2"></div>
                <div class="text-xs sm:text-sm font-bold text-neutral-800 dark:text-neutral-200 text-center px-1">${dp.time}</div>
              </div>
              <div class="flex-1 flex flex-col sm:flex-row sm:items-start sm:justify-between min-w-0 py-1">
                <div class="flex flex-col justify-center mb-2 sm:mb-0 w-full">
                  <h3 class="font-heading text-lg sm:text-2xl font-medium text-neutral-900 dark:text-white leading-tight">${ev.title||"Event"}</h3>
                  <div class="mt-1.5 text-xs sm:text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2">${[ev.locationName,ev.address].filter(Boolean).join(", ")}</div>
                  ${ev.wardrobe ? `
                    <div class="mt-3 flex items-start gap-2 rounded-lg bg-neutral-50 p-2 text-xs sm:text-sm text-neutral-600 dark:bg-neutral-800 dark:text-neutral-300">
                      <span class="text-lg">${ev.wardrobeIcon || 'üëî'}</span>
                      <div><strong class="font-semibold text-neutral-900 dark:text-white">Dress Code:</strong> ${ev.wardrobe}</div>
                    </div>
                  ` : ""}                  
                  ${ev.notes ? `<div class="mt-1.5 text-xs sm:text-sm italic text-neutral-500">${ev.notes}</div>` : ""}
                </div>
                <div class="shrink-0 flex flex-row sm:flex-col gap-4 sm:gap-2 mt-auto sm:mt-0 sm:items-end sm:text-right text-xs sm:text-sm font-medium pt-1 sm:pl-4">
                   ${(ev.mapUrl||details?.primaryVenue?.mapUrl) ? `<div class="flex flex-col"><span class="hidden sm:block text-[10px] uppercase tracking-wider text-neutral-400 font-bold mb-0.5">Location</span><a class="flex items-center gap-1.5 text-neutral-900 dark:text-white hover:underline decoration-neutral-400" href="${ev.mapUrl||details?.primaryVenue?.mapUrl}" target="_blank" rel="noopener"><span>üìç Maps</span><span class="hidden sm:inline">‚Üó</span></a></div>`:""}
                   <div class="flex flex-col sm:mt-2"><span class="hidden sm:block text-[10px] uppercase tracking-wider text-neutral-400 font-bold mb-0.5">Calendar</span><a class="flex items-center gap-1.5 text-neutral-900 dark:text-white hover:underline decoration-neutral-400" href="${buildGoogleCalendarLink(ev)}" target="_blank" rel="noopener"><span>üìÖ Add to</span></a></div>
                </div>
              </div>`;
            schedule.appendChild(item);
          }
        }

        // 5. Contacts
        const contacts = $("contacts");
        if (contacts) {
          contacts.innerHTML = ""; contacts.className = "mt-4 grid gap-3 sm:grid-cols-2";
          for (const c of details.contacts || []) {
             const el = document.createElement("div"); el.className = "flex items-center gap-3 rounded-xl border p-3 dark:border-neutral-800";
             const ph = String(c.phone||""); const link = ph.length>3 ? `tel:${ph.replace(/[^\d+]/g,'')}` : "#";
             el.innerHTML = `
               <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-neutral-100 dark:bg-neutral-800 text-lg">${c.icon||"üìû"}</div>
               <div class="flex-1 min-w-0"><div class="truncate font-medium text-neutral-900 dark:text-white">${c.name||"Contact"}</div><div class="truncate text-xs text-neutral-500">${c.role||""}</div></div>
               ${ph.length>3 ? `<a href="${link}" class="rounded-full bg-neutral-900 px-3 py-1.5 text-xs font-medium text-white transition-transform hover:scale-105 dark:bg-white dark:text-black">Call</a>` : ""}
             `;
             contacts.appendChild(el);
          }
        }

        applyTheme(details.theme); applyDecor(details); renderRsvp(details.rsvp); setupScrollObserver(); 
      } catch (e) { console.error(e); }
    }

    async function boot() {
      try {
        const res = await fetch(detailsUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("404");
        const DETAILS = await res.json();

        // 1. MODULAR THEME: Apply theme immediately from JSON
        initThemeEngine(DETAILS.theme);

        // 2. Render Invite Directly (No Lock Screen Logic)
        renderInvite(DETAILS);

      } catch (e) {
        console.error("Boot Error:", e);
        $("missingMsg")?.classList.remove("hidden");
      }
    }
    boot();
  </script>
</WeddingLayout>