---
import WeddingLayout from "../layouts/WeddingLayout.astro";
import { getImage } from "astro:assets";

// --- TEMPLATE IMPORTS ---
import PetalTemplate from "../components/templates/PetalTemplate.astro"; 
// import RoyalTemplate from "../components/templates/RoyalTemplate.astro"; // Coming soon
// import StoryTemplate from "../components/templates/StoryTemplate.astro"; // Coming soon

// 1. GET DATA (Cloudflare-Safe)
export async function getStaticPaths() {
  const dataFiles = import.meta.glob('../data/weddings/*.json', { eager: true });
  return Object.keys(dataFiles).map((path) => {
    const slug = path.split('/').pop().replace('.json', '');
    const data = dataFiles[path] as any;
    return {
      params: { slug },
      props: { data },
    };
  });
}

const { slug } = Astro.params;
const { data } = Astro.props;

// 2. MAP ALL ASSETS
const allAssets = import.meta.glob<{ default: ImageMetadata }>('/src/assets/weddings/**/*.{jpeg,jpg,png,gif,webp,JPG,PNG}');

// 3. OPTIMIZE COUPLE PHOTO(S)
// Logic: Optimize ALL images provided in the array so the Client can pick one randomly.
const rawSrc = data.media?.couplePhoto?.src;
const srcList = Array.isArray(rawSrc) ? rawSrc : (rawSrc ? [rawSrc] : []);

const optimizedCouplePhotos = await Promise.all(
  srcList.map(async (srcPath) => {
    if (!srcPath) return "";
    const cleanJsonSrc = srcPath.startsWith('/') ? srcPath.slice(1) : srcPath;
    const targetKey = `/src/assets/weddings/${cleanJsonSrc}`;
    const imageImport = allAssets[targetKey];

    if (imageImport) {
      const metaAsset = await imageImport();
      // Generate High-Res WebP
      const opt = await getImage({ src: metaAsset.default, format: 'webp', width: 1200 });
      return opt.src;
    }
    return srcPath; // Fallback if file not found in assets
  })
);

// 4. OPTIMIZE DECOR CORNERS
const cornerPaths = [
  '/src/assets/weddings/decor/decor-corner-1.png',
  '/src/assets/weddings/decor/decor-corner-2.png',
  '/src/assets/weddings/decor/decor-corner-3.png',
  '/src/assets/weddings/decor/decor-corner-4.png'
];

const optimizedCorners = await Promise.all(
  cornerPaths.map(async (path) => {
    const asset = allAssets[path];
    if (asset) {
      const meta = await asset();
      const opt = await getImage({ src: meta.default, width: 400 });
      return opt.src;
    }
    return "";
  })
);

// 5. METADATA
// We use the FIRST image for OpenGraph/WhatsApp previews to ensure consistency.
const mainImageForMeta = optimizedCouplePhotos[0] || "";
const domain = import.meta.env.SITE || "https://kokorolinks.com"; 
const meta = {
  title: data.coupleNames ? `${data.coupleNames} | Wedding Invitation` : "Wedding Invitation",
  description: data.tagline || `Join us to celebrate the wedding of ${data.coupleNames}.`,
  image: mainImageForMeta ? (mainImageForMeta.startsWith("http") ? mainImageForMeta : `${domain}${mainImageForMeta}`) : ""
};

const baseUrl = import.meta.env.BASE_URL;

// 6. DETERMINE TEMPLATE ID
// If "templateId" is missing in JSON, default to "joy"
const templateId = (data.templateId || "joy").toLowerCase();
---

<WeddingLayout 
  title={meta.title} 
  description={meta.description} 
  image={meta.image}
>
  
  {/* TEMPLATE SWITCHER LOGIC */}
  
  {templateId === 'petal' ? (
    <PetalTemplate 
      data={data}
      slug={slug}
      baseUrl={baseUrl}
      optimizedCouplePhotos={optimizedCouplePhotos}
      optimizedCorners={optimizedCorners}
    />
  ) : (
    /* Fallback/Error View if templateId is wrong */
    <div class="flex items-center justify-center min-h-screen bg-neutral-100 text-neutral-600">
      <div class="text-center">
        <h1 class="text-2xl font-bold mb-2">Template Not Found</h1>
        <p>The template ID <code>"{templateId}"</code> does not exist.</p>
      </div>
    </div>
  )}

</WeddingLayout>