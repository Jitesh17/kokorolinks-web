---
import WeddingLayout from "../layouts/WeddingLayout.astro";
import { getImage } from "astro:assets";
import type { WeddingData } from '../types';

// --- TEMPLATE IMPORTS ---
import PetalTemplate from "../components/templates/PetalTemplate.astro";
import RoyalTemplate from "../components/templates/RoyalTemplate.astro"; 

const TEMPLATE_MAP = {
  'petal': PetalTemplate,
  'royal': RoyalTemplate,
  // 'story': StoryTemplate 
};

// 1. GET DATA
export async function getStaticPaths() {
  const dataFiles = import.meta.glob('../data/weddings/*.json', { eager: true });
  return Object.keys(dataFiles).map((path) => {
    const slug = path.split('/').pop().replace('.json', '');
    const data = dataFiles[path] as any;
    return { params: { slug }, props: { data } };
  });
}

// 2. PREPARE PROPS
const { slug } = Astro.params;
const data = Astro.props.data as WeddingData;

// 3. MAP ASSETS
const allAssets = import.meta.glob<{ default: ImageMetadata }>('/src/assets/weddings/**/*.{jpeg,jpg,png,gif,webp,JPG,PNG}');

// 4. OPTIMIZE COUPLE PHOTO(S)
const rawSrc = data.media?.couplePhoto?.src;
const srcList = Array.isArray(rawSrc) ? rawSrc : (rawSrc ? [rawSrc] : []);

const optimizedCouplePhotos = await Promise.all(
  srcList.map(async (srcPath) => {
    if (!srcPath) return "";
    const cleanJsonSrc = srcPath.startsWith('/') ? srcPath.slice(1) : srcPath;
    const targetKey = `/src/assets/weddings/${cleanJsonSrc}`;
    const imageImport = allAssets[targetKey];
    if (imageImport) {
      const metaAsset = await imageImport();
      return (await getImage({ src: metaAsset.default, format: 'webp', width: 1200 })).src;
    }
    return srcPath; 
  })
);

// 5. OPTIMIZE DECOR CORNERS
const cornerPaths = [
  '/src/assets/weddings/decor/decor-corner-1.png',
  '/src/assets/weddings/decor/decor-corner-2.png',
  '/src/assets/weddings/decor/decor-corner-3.png',
  '/src/assets/weddings/decor/decor-corner-4.png'
];
const optimizedCorners = await Promise.all(
  cornerPaths.map(async (path) => {
    const asset = allAssets[path];
    if (asset) {
      const meta = await asset();
      return (await getImage({ src: meta.default, width: 400 })).src;
    }
    return "";
  })
);

// 6. METADATA
const mainImageForMeta = optimizedCouplePhotos[0] || "";
const domain = import.meta.env.SITE || "https://kokorolinks.com"; 
const meta = {
  title: data.coupleNames ? `${data.coupleNames} | Wedding Invitation` : "Wedding Invitation",
  description: data.tagline || `Join us to celebrate.`,
  image: mainImageForMeta ? (mainImageForMeta.startsWith("http") ? mainImageForMeta : `${domain}${mainImageForMeta}`) : ""
};
const baseUrl = import.meta.env.BASE_URL;

// 7. DETERMINE TEMPLATE COMPONENT
const templateId = (data.templateId || "petal").toLowerCase();

// LOOKUP LOGIC:
// We look up the component. If it exists, 'TemplateComponent' holds the component.
// If it doesn't exist (e.g., "garbage"), it is undefined.
const TemplateComponent = TEMPLATE_MAP[templateId as keyof typeof TEMPLATE_MAP];
---

<WeddingLayout title={meta.title} description={meta.description} image={meta.image}>
  
  {/* DYNAMIC RENDER LOGIC 
      Check if the component was found in the map.
  */}
  {TemplateComponent ? (
      <TemplateComponent 
        data={data}
        slug={slug}
        baseUrl={baseUrl}
        optimizedCouplePhotos={optimizedCouplePhotos}
        optimizedCorners={optimizedCorners}
      />
  ) : (
    /* Fallback Error View */
    <div class="flex items-center justify-center min-h-screen bg-neutral-100 text-neutral-600">
      <div class="text-center">
        <h1 class="text-2xl font-bold mb-2">Template Not Found</h1>
        <p>The template ID <code>"{templateId}"</code> does not exist.</p>
        <p class="text-xs mt-4 text-neutral-400">Available templates: {Object.keys(TEMPLATE_MAP).join(", ")}</p>
      </div>
    </div>
  )}

</WeddingLayout>