---
// src/components/templates/RoyalTemplate.astro
import { getThemeVariables } from "../../lib/themeEngine";

const { data, optimizedCouplePhotos, slug, baseUrl } = Astro.props;
const themeConfig = data.theme || {};
const cssVars = getThemeVariables(themeConfig);

let initialImageSrc = "";
if (optimizedCouplePhotos && optimizedCouplePhotos.length > 0) {
   initialImageSrc = optimizedCouplePhotos[0];
} else if (data.media?.couplePhoto?.src) {
   initialImageSrc = Array.isArray(data.media.couplePhoto.src) ? data.media.couplePhoto.src[0] : data.media.couplePhoto.src;
}
---

<div id="royalTemplateRoot" style={cssVars} class="bg-skin bg-texture-paper text-ink min-h-screen relative overflow-hidden font-heading">
    
    <div class="absolute inset-4 z-20 pointer-events-none border-[3px] border-double border-primary/60 rounded-xl"></div>
    <div class="absolute inset-6 z-20 pointer-events-none border border-primary/30 rounded-lg"></div>

    <div class="absolute top-8 left-8 z-20 text-primary/60 text-4xl leading-none">❧</div>
    <div class="absolute top-8 right-8 z-20 text-primary/60 text-4xl leading-none rotate-90">❧</div>
    <div class="absolute bottom-8 left-8 z-20 text-primary/60 text-4xl leading-none -rotate-90">❧</div>
    <div class="absolute bottom-8 right-8 z-20 text-primary/60 text-4xl leading-none rotate-180">❧</div>

    <main class="relative z-10 container-max px-6 py-32 flex flex-col items-center text-center">

        <header class="mb-16 space-y-6">
             <p class="text-xs md:text-sm uppercase tracking-[0.4em] text-primary/80 font-body">The Wedding Celebration of</p>
             
             <h1 class="text-6xl md:text-8xl leading-tight font-bold text-gold-foil drop-shadow-sm pb-2 font-heading">
               {data.coupleNames}
             </h1>
             
             <p class="text-xl italic text-ink/80 max-w-xl mx-auto font-serif">
               {data.tagline}
             </p>
        </header>

        <div id="couplePhotoWrap" class="relative mb-20 group">
             <div class="absolute -inset-4 border border-primary/30 rounded-t-full rounded-b-[200px] scale-105 opacity-60"></div>
            
            <div class="relative w-[300px] h-[400px] md:w-[400px] md:h-[550px] rounded-t-full rounded-b-[200px] overflow-hidden shadow-2xl border-[3px] border-primary/80">
                <img 
                  id="couplePhoto" 
                  src={initialImageSrc}
                  alt={data.coupleNames}
                  class="w-full h-full object-cover opacity-95 hover:scale-105 transition-transform duration-1000" 
                  loading="eager"
                />
            </div>
        </div>

        <section class="mb-20 space-y-8 w-full max-w-2xl">
            <div class="flex items-center justify-center gap-4 opacity-60">
                <div class="h-px w-16 bg-primary"></div>
                <div class="text-primary text-xl">♦</div>
                <div class="h-px w-16 bg-primary"></div>
            </div>

            <div class="space-y-2">
                <h2 class="text-4xl md:text-5xl text-gold-foil font-bold">
                    {data.primaryEvent?.displayDate}
                </h2>
                <p class="text-lg uppercase tracking-widest text-ink/80">{data.cityLine}</p>
            </div>
            
            <div id="countdown" class="flex justify-center my-12 text-primary font-body"></div>

            <div class="flex flex-wrap justify-center gap-6">
                 <a id="mapBtn" target="_blank" rel="noopener" class="px-10 py-4 bg-primary text-skin uppercase tracking-[0.15em] text-xs font-bold shadow-xl hover:bg-primary/90 transition-transform hover:-translate-y-1 cursor-pointer rounded-sm">
                    View Map
                 </a>
                 <a id="viewCalendarBtn" target="_blank" rel="noopener" class="px-10 py-4 border border-primary text-primary uppercase tracking-[0.15em] text-xs font-bold hover:bg-primary hover:text-skin transition-colors cursor-pointer rounded-sm">
                    Add to Calendar
                 </a>
            </div>
        </section>

        <section class="w-full max-w-3xl mb-24">
            <h2 class="text-3xl text-gold-foil mb-16 uppercase tracking-[0.2em] font-bold border-b border-primary/20 pb-6 inline-block">Order of Events</h2>
            <div id="schedule" class="space-y-16">
                </div>
        </section>

         <section class="w-full max-w-4xl grid md:grid-cols-2 gap-16 text-left border-t border-primary/20 pt-16">
            <div id="rsvpSection" style="display:none;" class="text-center md:text-left">
                <h3 class="text-2xl text-gold-foil mb-6 uppercase tracking-wide font-bold">RSVP</h3>
                <p id="rsvpDeadlineText" class="mb-6 text-ink/70 font-serif italic"></p>
                 <a id="rsvpButton" class="inline-block px-8 py-3 bg-primary text-skin uppercase tracking-wider text-sm font-bold shadow-lg cursor-pointer rounded-sm">
                    Confirm Attendance
                 </a>
            </div>
            <div class="text-center md:text-right">
                <h3 class="text-2xl text-gold-foil mb-6 uppercase tracking-wide font-bold">The Hosts</h3>
                <div id="contacts" class="space-y-6 flex flex-col items-center md:items-end">
                     </div>
            </div>
         </section>
    </main>

    <noscript>
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-skin text-primary p-10 text-center">
            <h1 class="text-2xl">Javascript Required</h1>
        </div>
    </noscript>

</div>

<script is:inline define:vars={{ preloadedData: data, optimizedCouplePhotos, baseUrl, slug }}>
  const $ = (id) => document.getElementById(id);

  // --- HELPERS ---
  function pad2(n) { return String(n).padStart(2, "0"); }
  function isAbsUrl(u) { return typeof u === "string" && /^(https?:|data:)/i.test(u); }
  function resolveAssetUrl(u) {
    if (!u) return "";
    if (isAbsUrl(u)) return u;
    const baseNoSlash = String(baseUrl || "/").replace(/\/$/, "");
    return u.startsWith("/") ? baseNoSlash + u : String(baseUrl || "/") + u;
  }
  function formatLocal(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit" });
  }

  // --- RENDERERS ---

  function renderCountdown(el, targetIso) {
    if (!el) return;
    el.innerHTML = `
      <div class="flex gap-6 md:gap-12 text-center items-center">
        <div><div class="text-4xl md:text-5xl font-heading" data-type="d">0</div><div class="text-[10px] uppercase tracking-widest opacity-60 mt-1">Days</div></div>
        <div class="text-2xl opacity-30 font-serif">/</div>
        <div><div class="text-4xl md:text-5xl font-heading" data-type="h">00</div><div class="text-[10px] uppercase tracking-widest opacity-60 mt-1">Hrs</div></div>
        <div class="text-2xl opacity-30 font-serif">/</div>
        <div><div class="text-4xl md:text-5xl font-heading" data-type="m">00</div><div class="text-[10px] uppercase tracking-widest opacity-60 mt-1">Mins</div></div>
      </div>
    `;
    const [dEl, hEl, mEl] = ['d','h','m'].map(k => el.querySelector(`[data-type="${k}"]`));
    function tick() {
      const ms = new Date(targetIso).getTime() - Date.now();
      if (ms <= 0) { el.innerHTML = `<div class="text-2xl font-serif italic text-gold-foil">Happening Now</div>`; return false; }
      const s = Math.floor(ms/1000);
      if (dEl) dEl.textContent = Math.floor(s/86400);
      if (hEl) hEl.textContent = pad2(Math.floor((s%86400)/3600));
      if (mEl) mEl.textContent = pad2(Math.floor((s%3600)/60));
      return true;
    }
    if (tick()) setInterval(tick, 1000);
  }

  function buildGoogleCalendarLink(ev) {
      const start = new Date(ev?.start); const end = new Date(ev?.end);
      if (isNaN(start) || isNaN(end)) return "https://calendar.google.com/";
      const fmt = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev?.title||"Event")}&dates=${fmt(start)}/${fmt(end)}&location=${encodeURIComponent(ev?.locationName||"")}`;
  }

  function renderSchedule(details) {
      const scheduleEl = $("schedule");
      if (!scheduleEl || !details.schedule) return;
      scheduleEl.innerHTML = '';
      
      details.schedule.forEach((ev, index) => {
         const d = new Date(ev.start);
         const day = d.getDate();
         const month = d.toLocaleDateString('en-US',{month:'short'});
         const time = d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});

         const item = document.createElement("div");
         // Simplified, elegant centered list for Royal theme
         item.className = `flex flex-col md:flex-row gap-8 md:gap-16 items-center text-center md:text-left group`;
         
         item.innerHTML = `
            <div class="shrink-0 w-24 h-24 rounded-full border border-primary/40 flex flex-col items-center justify-center bg-skin/50 relative z-10 group-hover:border-primary transition-colors">
                <div class="text-xs uppercase tracking-widest opacity-60 font-body">${month}</div>
                <div class="text-3xl text-primary font-heading font-bold">${day}</div>
            </div>
            
            <div class="flex-1 space-y-1">
                <h3 class="text-2xl text-gold-foil font-bold">${ev.title}</h3>
                <div class="text-md text-ink/80 font-serif italic">${time}  —  ${ev.locationName || ''}</div>
                ${ev.wardrobe ? `<div class="text-xs mt-3 uppercase tracking-widest opacity-60 border-t border-primary/10 pt-2 inline-block">Dress: ${ev.wardrobe}</div>` : ''}
            </div>
            
            <div class="shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                 <a href="${buildGoogleCalendarLink(ev)}" target="_blank" class="w-10 h-10 rounded-full border border-primary/30 flex items-center justify-center text-primary hover:bg-primary hover:text-skin transition-colors">
                    +
                 </a>
            </div>
         `;
         scheduleEl.appendChild(item);
      });
  }

  function renderContacts(details) {
    const contEl = $("contacts");
    if(!contEl || !details.contacts) return;
    contEl.innerHTML = '';
    details.contacts.forEach(c => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-4 text-right";
        const link = c.phone ? `tel:${c.phone.replace(/[^\d+]/g,'')}` : '#';
        div.innerHTML = `
           <div>
               <div class="text-lg text-primary font-bold">${c.name}</div>
               <div class="text-xs uppercase tracking-widest opacity-60">${c.role || ''}</div>
               ${c.phone ? `<a href="${link}" class="text-sm mt-1 block hover:text-primary transition-colors font-serif italic">${c.phone}</a>` : ''}
           </div>
        `;
        contEl.appendChild(div);
    });
  }

  function renderRsvp(rsvp) {
    const section = $("rsvpSection");
    const button = $("rsvpButton");
    if (!section || !button || !rsvp || !rsvp.enabled) return;
    
    section.style.display = "block";
    if(rsvp.deadline) {
       $("rsvpDeadlineText").textContent = `Kindly respond by ${formatLocal(rsvp.deadline)}`;
    }
    
    if (rsvp.formUrl) {
        button.href = rsvp.formUrl;
        button.target = "_blank";
        button.textContent = rsvp.buttonText || "RSVP Now";
    }
  }

  function renderPhoto(details) {
    const img = $("couplePhoto");
    if(!img) return;
    
    let selectedSrc = "";
    if (optimizedCouplePhotos && optimizedCouplePhotos.length > 0) {
      selectedSrc = optimizedCouplePhotos[Math.floor(Math.random() * optimizedCouplePhotos.length)];
    } else if (details.media?.couplePhoto?.src) {
       const raw = details.media.couplePhoto.src;
       selectedSrc = Array.isArray(raw) ? raw[0] : raw;
       selectedSrc = resolveAssetUrl(selectedSrc);
    }

    if(selectedSrc && img.src !== selectedSrc) {
        img.src = selectedSrc;
    }

    const pos = details.media?.couplePhoto?.position;
    if(pos) img.style.objectPosition = pos;
  }

  function boot(details) {
    try {
        if(details.primaryEvent?.start) renderCountdown($("countdown"), details.primaryEvent.start);
        if(details.primaryVenue?.mapUrl) $("mapBtn").href = details.primaryVenue.mapUrl;
        
        const baseNoSlash = String(baseUrl || "/").replace(/\/$/, "");
        const calUrl = `${baseNoSlash}/weddings/calendars/${slug}.ics`;
        $("viewCalendarBtn").href = calUrl;

        renderPhoto(details);
        renderSchedule(details);
        renderContacts(details);
        renderRsvp(details.rsvp);

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.classList.add('animate-in');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        
        document.querySelectorAll('section, header, #couplePhotoWrap').forEach(el => {
             el.classList.add('opacity-0', 'translate-y-8', 'transition-all', 'duration-1000');
             observer.observe(el);
        });
        const style = document.createElement('style');
        style.innerHTML = `.animate-in { opacity: 1 !important; transform: translateY(0) !important; }`;
        document.head.appendChild(style);

    } catch(e) { console.error("Royal Template Boot Error", e); }
  }

  boot(preloadedData);
</script>