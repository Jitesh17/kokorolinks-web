---
const ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
---

<dialog 
  id="contact-modal" 
  class="group fixed inset-0 z-[100] w-full h-full bg-transparent p-4 hidden open:flex items-center justify-center backdrop:bg-stone-900/60 backdrop:backdrop-blur-sm transition-all duration-300"
>  
  <div class="relative w-full max-w-lg bg-white dark:bg-stone-900 border border-stone-100 dark:border-stone-800 rounded-3xl shadow-2xl overflow-hidden scale-95 opacity-0 transition-all duration-300 group-open:scale-100 group-open:opacity-100 p-8 md:p-10">
    
    <button id="close-modal" class="absolute top-4 right-4 p-2 text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
    </button>

    <div class="text-center mb-8">
      <span class="font-body text-xs font-bold uppercase tracking-[0.2em] text-rose-600 mb-2 block">
        Start Your Journey
      </span>
      <h3 class="font-heading text-3xl text-stone-900 dark:text-stone-50">
        Request Your Link
      </h3>
      <p class="text-stone-500 text-sm mt-2">
        Tell us a bit about your event. We'll get back to you within 24 hours.
      </p>
    </div>

    <form id="kokoro-form" class="space-y-4">
      
      <input type="hidden" name="access_key" value={ACCESS_KEY} />
      <input type="hidden" name="from_name" value="KokoroLinks Website" />
      <input type="hidden" name="subject" value="New Inquiry from KokoroLinks" />
      <input type="checkbox" name="botcheck" class="hidden" style="display: none;">

      <div class="space-y-1">
        <label for="name" class="text-xs font-bold uppercase tracking-wider text-stone-500">Your Names</label>
        <input type="text" name="name" id="name" required placeholder="e.g. Rohan & Maya"
          class="w-full bg-stone-50 dark:bg-stone-950 border border-stone-200 dark:border-stone-800 rounded-lg px-4 py-3 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-rose-500 focus:border-transparent outline-none transition-all"
        />
      </div>

      <div class="space-y-1">
        <label for="email" class="text-xs font-bold uppercase tracking-wider text-stone-500">Email Address</label>
        <input type="email" name="email" id="email" required placeholder="you@example.com"
          class="w-full bg-stone-50 dark:bg-stone-950 border border-stone-200 dark:border-stone-800 rounded-lg px-4 py-3 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-rose-500 focus:border-transparent outline-none transition-all"
        />
      </div>

      <div class="space-y-1">
        <label for="date" class="text-xs font-bold uppercase tracking-wider text-stone-500">Tentative Date</label>
        <input type="date" name="date" id="date"
          class="w-full bg-stone-50 dark:bg-stone-950 border border-stone-200 dark:border-stone-800 rounded-lg px-4 py-3 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-rose-500 focus:border-transparent outline-none transition-all"
        />
      </div>

      <div class="space-y-1">
        <label for="message" class="text-xs font-bold uppercase tracking-wider text-stone-500">Vision / Notes</label>
        <textarea name="message" id="message" rows="3" placeholder="We want a minimalist theme with a focus on photos..."
          class="w-full bg-stone-50 dark:bg-stone-950 border border-stone-200 dark:border-stone-800 rounded-lg px-4 py-3 text-stone-900 dark:text-stone-100 focus:ring-2 focus:ring-rose-500 focus:border-transparent outline-none transition-all resize-none"
        ></textarea>
      </div>

      <button type="submit" id="submit-btn" class="w-full bg-stone-900 dark:bg-stone-100 text-white dark:text-stone-900 font-bold py-4 rounded-xl hover:bg-stone-800 dark:hover:bg-stone-200 transition-all shadow-lg mt-4 flex justify-center items-center gap-2">
        <span>Send Request</span>
        <span id="loading-spinner" class="hidden animate-spin">⏳</span>
      </button>

      <p id="form-status" class="text-center text-sm font-medium mt-2 hidden"></p>

    </form>
  </div>
</dialog>

<script>
  // MODAL LOGIC
  const modal = document.getElementById('contact-modal') as HTMLDialogElement;
  const closeBtn = document.getElementById('close-modal');
  const form = document.getElementById('kokoro-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn');
  const statusMsg = document.getElementById('form-status');
  const spinner = document.getElementById('loading-spinner');

  // Open Modal (Function to be called globally)
  window.openContactModal = () => {
    modal?.showModal();
    // Small timeout to allow the 'open' attribute to apply before adding opacity
    setTimeout(() => modal.classList.add('opacity-100'), 10);
  };

  // Close Modal
  const closeModal = () => {
    modal.classList.remove('opacity-100');
    setTimeout(() => {
      modal?.close();
      statusMsg.classList.add('hidden');
      form.reset();
    }, 300); // Wait for transition
  };

  closeBtn?.addEventListener('click', closeModal);

  // Close when clicking backdrop
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // FORM SUBMISSION LOGIC (Web3Forms AJAX)
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // UI Loading State
    const originalText = submitBtn.querySelector('span').innerText;
    submitBtn.querySelector('span').innerText = "Sending...";
    submitBtn.disabled = true;
    spinner.classList.remove('hidden');
    statusMsg.classList.add('hidden');

    const formData = new FormData(form);
    const object = Object.fromEntries(formData);
    const json = JSON.stringify(object);

    try {
      const response = await fetch("https://api.web3forms.com/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: json,
      });

      const result = await response.json();

      if (response.status === 200) {
        statusMsg.innerText = "✓ Message sent! We'll be in touch.";
        statusMsg.className = "text-center text-sm font-medium mt-2 text-green-600";
        statusMsg.classList.remove('hidden');
        setTimeout(closeModal, 2000);
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      console.log(error);
      statusMsg.innerText = "Something went wrong. Please try again.";
      statusMsg.className = "text-center text-sm font-medium mt-2 text-red-600";
      statusMsg.classList.remove('hidden');
    } finally {
      // Reset Button
      submitBtn.querySelector('span').innerText = originalText;
      submitBtn.disabled = false;
      spinner.classList.add('hidden');
    }
  });
</script>

<script>
  declare global {
    interface Window {
      openContactModal: () => void;
    }
  }
</script>